#!/bin/sh
# alf scope â€” waveform for audio, dir sparklines, fallback for the rest
set -C -f

file="$1"
w="$2"
h="$3"

if [ -d "$file" ]; then
    has_audio=$(find "$file" -maxdepth 1 -type f \( -iname '*.wav' -o -iname '*.mp3' -o -iname '*.flac' -o -iname '*.ogg' -o -iname '*.aif' -o -iname '*.aiff' -o -iname '*.opus' -o -iname '*.m4a' \) 2>/dev/null | head -1)
    if [ -n "$has_audio" ]; then
        alf-list "$file"
        exit 0
    fi
fi

case "$(file --dereference --brief --mime-type -- "$file")" in
    audio/*)
        pos_arg=""
        if [ -f /tmp/alf/file ] && [ -f /tmp/alf/pos ]; then
            playing="$(cat /tmp/alf/file)"
            real="$(readlink -f "$file")"
            if [ "$playing" = "$real" ]; then
                pos_arg="-p $(cat /tmp/alf/pos)"
            fi
        fi
        aw -w "$w" -H 10 $pos_arg "$file"
        ;;
    *)
        if [ -x "$HOME/.config/lf/scope" ]; then
            exec "$HOME/.config/lf/scope" "$@"
        else
            file --brief "$file"
        fi
        ;;
esac
