#!/bin/sh
# alf scope â€” waveform for audio (with playback progress), sparkline list for dirs
set -C -f

file="$1"
w="$2"
h="$3"

if [ -d "$file" ]; then
    has_audio=$(find "$file" -maxdepth 1 -type f \( -iname '*.wav' -o -iname '*.mp3' -o -iname '*.flac' -o -iname '*.ogg' -o -iname '*.aif' -o -iname '*.aiff' -o -iname '*.opus' -o -iname '*.m4a' \) 2>/dev/null | head -1)
    if [ -n "$has_audio" ]; then
        aw -d -w "$w" "$file"
        exit 0
    fi
fi

case "$(file --dereference --brief --mime-type -- "$file")" in
    audio/*)
        pos_arg=""
        state_file="/tmp/alf/file"
        pos_file="/tmp/alf/pos"
        if [ -f "$state_file" ] && [ -f "$pos_file" ]; then
            playing="$(cat "$state_file")"
            real="$(readlink -f "$file")"
            if [ "$playing" = "$real" ]; then
                pos="$(cat "$pos_file")"
                pos_arg="-p $pos"
            fi
        fi
        aw -w "$w" -H "$((h - 2))" $pos_arg "$file"
        ;;
    *)
        if [ -x "$HOME/.config/lf/scope" ]; then
            exec "$HOME/.config/lf/scope" "$@"
        else
            file --brief "$file"
        fi
        ;;
esac
