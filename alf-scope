#!/bin/sh
# alf scope â€” sixel waveform for audio, dir columns, fallback for the rest
set -C -f

file="$1"
w="$2"
h="$3"

if [ -d "$file" ]; then
    has_audio=$(find "$file" -maxdepth 1 -type f \( -iname '*.wav' -o -iname '*.mp3' -o -iname '*.flac' -o -iname '*.ogg' -o -iname '*.aif' -o -iname '*.aiff' -o -iname '*.opus' -o -iname '*.m4a' \) 2>/dev/null | head -1)
    if [ -n "$has_audio" ]; then
        alf-list "$file"
        exit 0
    fi
fi

case "$(file --dereference --brief --mime-type -- "$file")" in
    audio/*)
        # sixel waveform via ffmpeg + img2sixel (st-sx)
        pw=$((w * 8))
        ph=$((h * 14))
        ffmpeg -i "$file" -filter_complex \
            "showwavepic=s=${pw}x${ph}:colors=#66bb6a|#1a1a1a:split_channels=0" \
            -frames:v 1 -f image2pipe -vcodec png - 2>/dev/null \
            | img2sixel -w "$pw"
        ;;
    *)
        if [ -x "$HOME/.config/lf/scope" ]; then
            exec "$HOME/.config/lf/scope" "$@"
        else
            file --brief "$file"
        fi
        ;;
esac
