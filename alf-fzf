#!/bin/sh
# alf-fzf — audio file browser with sortable columns. fzf + waveform preview.
set -e

DIR="${1:-.}"
DIR="$(readlink -f "$DIR")"
SORT="${ALF_SORT:-name}"

preview_cmd="aw -w \$FZF_PREVIEW_COLUMNS -H \$FZF_PREVIEW_LINES \"$DIR/\$(echo {} | sed 's/.*  //')\""
play_cmd="alf-play pause \"$DIR/\$(echo {} | sed 's/.*  //')\" 0"
stop_cmd="alf-play stop"

alf-list --sort "$SORT" "$DIR" | fzf \
    --ansi \
    --no-sort \
    --layout=reverse \
    --header=" wave                 bpm  key    dur   size  name   │ a-p:play a-x:stop a-n/b/d/k/z:sort a-i:index" \
    --preview "$preview_cmd" \
    --preview-window "right:50%:wrap" \
    --bind "alt-p:execute-silent($play_cmd)" \
    --bind "alt-x:execute-silent($stop_cmd)" \
    --bind "alt-n:reload(alf-list --sort name \"$DIR\")" \
    --bind "alt-b:reload(alf-list --sort bpm \"$DIR\")" \
    --bind "alt-d:reload(alf-list --sort dur \"$DIR\")" \
    --bind "alt-k:reload(alf-list --sort key \"$DIR\")" \
    --bind "alt-z:reload(alf-list --sort size \"$DIR\")" \
    --bind "alt-i:execute-silent(alf-index \"$DIR\")+reload(alf-list --sort $SORT \"$DIR\")" \
    --bind "enter:execute-silent($play_cmd)" \
    --bind "esc:execute-silent($stop_cmd)+abort" \
    --multi
