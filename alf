#!/bin/sh
# alf — audio file browser. fzf + waveform preview + mpd playback.
set -e

DIR="${1:-.}"
DIR="$(readlink -f "$DIR")"
SORT="${ALF_SORT:-name}"

# preview: full waveform. field 5+ is the filename
preview_cmd="aw -w \$FZF_PREVIEW_COLUMNS -H \$FZF_PREVIEW_LINES \$(echo {} | awk '{print \"$DIR/\"\$5}')"

# play: extract filename from last field
play_cmd="alf-play pause \"$DIR/\$(echo {} | awk '{print \$5}')\" 0"
stop_cmd="alf-play stop"

alf-list --sort "$SORT" "$DIR" | fzf \
    --ansi \
    --no-sort \
    --layout=reverse \
    --header=" wave      bpm    dur   size  name   │ a-p:play a-s:stop a-n/b/d:sort a-i:index a-a:autoplay" \
    --preview "$preview_cmd" \
    --preview-window "right:50%:wrap" \
    --bind "alt-p:execute-silent($play_cmd)" \
    --bind "alt-s:execute-silent($stop_cmd)" \
    --bind "alt-n:reload(alf-list --sort name \"$DIR\")" \
    --bind "alt-b:reload(alf-list --sort bpm \"$DIR\")" \
    --bind "alt-d:reload(alf-list --sort dur \"$DIR\")" \
    --bind "alt-z:reload(alf-list --sort size \"$DIR\")" \
    --bind "alt-i:execute-silent(alf-index \"$DIR\")+reload(alf-list --sort $SORT \"$DIR\")" \
    --bind "alt-a:execute-silent(alf-play autoplay toggle)" \
    --bind "enter:execute-silent($play_cmd)" \
    --bind "esc:execute-silent($stop_cmd)+abort" \
    --multi
